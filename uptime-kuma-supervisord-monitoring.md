# Supervisord Health Monitoring with Uptime Kuma Push Monitors

This document describes how to monitor the `supervisord` service on Linux servers using **Uptime Kuma Push monitors** and a small shell script with `cron`.  
It is written so you can drop it directly into a Git repository (e.g. as `SUPERVISORD_UPTIME_KUMA.md`).

---

## 1. Purpose

We want to:

- Detect when the **`supervisord`** service is **down or not active** on any server.
- Send its status to **Uptime Kuma** using a **Push** monitor.
- Get alerts in a **chat channel** (e.g. Google Chat, Slack, etc.) when:
  - `supervisord` goes **DOWN**
  - `supervisord` comes back **UP**

This example uses:

- Uptime Kuma URL: `http://10.9.0.55:3001`
- Service name: `supervisord`
- One Push monitor token: `AWbUXTosJG`

You can adapt these values per environment.

---

## 2. Prerequisites

On the **Uptime Kuma server**:

- Uptime Kuma is installed and reachable at e.g. `http://10.9.0.55:3001`.
- A notification channel (e.g. Google Chat webhook) is already configured in Kuma.

On each **application server** to be monitored:

- Linux with `systemd` (`systemctl` available).
- Supervisor service installed and managed by systemd:
  - Usually unit name: `supervisord` (or sometimes `supervisor`).
- `curl` installed.
- Root access (or a user with permission to read service status and install cron jobs).

---

## 3. Create a Push Monitor in Uptime Kuma

1. Log in to **Uptime Kuma** (e.g. `http://10.9.0.55:3001`).
2. Click the **‚Äú+ Add New Monitor‚Äù** button on the left.
3. Fill in:
   - **Monitor Type:** `Push`
   - **Friendly Name:** e.g. `supervisord - tk-app3-10-10-67-113`
   - Leave the other values at defaults (you can tune them later).
4. Click **Save**.

### 3.1. Get the Push URL and Token

1. After saving, click on your new monitor in the left list.
2. On the right side you will see:
   - A **Push URL** or example `curl` command, such as:

     ```text
     http://10.9.0.55:3001/api/push/AWbUXTosJG?status=up&msg=OK
     ```

3. The token is the random string after `/api/push/` and before `?status`:

   ```text
   http://10.9.0.55:3001/api/push/<TOKEN>?status=...
                                 ^^^^^^^
   ```

   In our example, the **token** is:

   ```text
   AWbUXTosJG
   ```

> üîë **Important:** Do **not** invent the token. Always copy the exact URL and token generated by Uptime Kuma.

### 3.2. Turn Off ‚ÄúUpside Down Mode‚Äù

To keep the logic simple and intuitive:

- `status=up` ‚Üí service is healthy.
- `status=down` ‚Üí service has a problem.

For that:

1. Click the monitor ‚Üí **Edit**.
2. Make sure **‚ÄúUpside Down Mode‚Äù** is **OFF**.
3. Click **Save**.

---

## 4. Attach a Notification (e.g. Google Chat)

1. In Uptime Kuma, go to **Settings ‚Üí Notifications**.
2. Create a new notification for your chat platform (e.g. Google Chat webhook).
3. Test it to confirm a test message reaches your chat channel.
4. Go back to your Push monitor (**Edit ‚Üí Notifications** tab).
5. Attach the notification to this monitor:
   - Enable ‚ÄúAlert on DOWN‚Äù.
   - Optionally enable ‚ÄúAlert on UP‚Äù.
6. Save.

Now Uptime Kuma will notify your chat channel whenever the monitor goes **Down** or back **Up**.

---

## 5. Shell Script on Each Server

This script:

- Uses `systemctl is-active` to check whether `supervisord` is active.
- Sends `status=up` or `status=down` to Uptime Kuma via the Push URL.
- Is suitable for running via `cron`.

### 5.1. Script Content

On each server, create:

`/usr/local/bin/check_supervisord.sh`

```bash
#!/usr/bin/bash
# Safe PATH for non-interactive environments like cron
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

# Name of the systemd unit to check
SERVICE_NAME="supervisord"    # change to "supervisor" if that's your unit name

# Uptime Kuma settings
KUMA_URL="http://10.9.0.55:3001"
TOKEN="AWbUXTosJG"

# Check service status using systemd
if /usr/bin/systemctl is-active --quiet "$SERVICE_NAME"; then
    STATUS="up"
    MSG="${SERVICE_NAME}_activated"
else
    STATUS="down"
    MSG="${SERVICE_NAME}_not_activated"
fi

# Send status to Uptime Kuma Push monitor
/usr/bin/curl -fsS "${KUMA_URL}/api/push/${TOKEN}?status=${STATUS}&msg=${MSG}" >/dev/null 2>&1
```

> ‚úÖ You can reuse the same `TOKEN` for multiple servers if you want a **single monitor for a group of servers**, or create one monitor per server (recommended for visibility) and use a different token on each.

### 5.2. Make the Script Executable

```bash
chmod +x /usr/local/bin/check_supervisord.sh
```

### 5.3. Test Manually

Run once:

```bash
/usr/local/bin/check_supervisord.sh
```

Check:

- In Uptime Kuma:
  - The monitor should receive a new entry with `msg=supervisord_activated` (if service is up), or `supervisord_not_activated` (if service is down).
- In your chat channel:
  - You should receive a notification **only if** the state changed from UP ‚Üí DOWN or DOWN ‚Üí UP.

---

## 6. Configure Cron

We want the script to run automatically every minute.

Edit **root‚Äôs crontab**:

```bash
crontab -e
```

Add:

```cron
* * * * * /usr/local/bin/check_supervisord.sh >> /var/log/check_supervisord.log 2>&1
```

This will:

- Run the script every minute.
- Append any errors (if any) to `/var/log/check_supervisord.log`.

### 6.1. Ensure Cron Service is Running

On systems using `crond`:

```bash
systemctl enable --now crond
systemctl status crond
```

---

## 7. Testing End-to-End

1. **Normal state (UP)**

   - Ensure `supervisord` is running:

     ```bash
     systemctl status supervisord
     ```

   - Wait a minute and verify:
     - Uptime Kuma shows the monitor as **UP**.
     - No new ‚ÄúDOWN‚Äù messages in chat.

2. **Simulate failure (DOWN)**

   - Stop `supervisord`:

     ```bash
     systemctl stop supervisord
     ```

   - Wait 1‚Äì2 minutes.
   - You should see:
     - Uptime Kuma marks the monitor as **DOWN**.
     - Your chat channel receives a **‚Äúwent down‚Äù** notification with `supervisord_not_activated`.

3. **Recovery (UP again)**

   - Start `supervisord`:

     ```bash
     systemctl start supervisord
     ```

   - Wait 1‚Äì2 minutes.
   - You should see:
     - Uptime Kuma marks the monitor as **UP** again.
     - Your chat channel receives a **‚Äúback online‚Äù** notification with `supervisord_activated`.

---

## 8. One-Shot Setup Command (Per Server)

If you want to automate the setup on each server with a single command block, you can run:

```bash
TOKEN="AWbUXTosJG"
KUMA_URL="http://10.9.0.55:3001"
SERVICE_NAME="supervisord"   # change if your unit is named differently

# 1) Create/update the script
cat >/usr/local/bin/check_supervisord.sh <<EOF
#!/usr/bin/bash
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin

SERVICE_NAME="${SERVICE_NAME}"
KUMA_URL="${KUMA_URL}"
TOKEN="${TOKEN}"

if /usr/bin/systemctl is-active --quiet "\$SERVICE_NAME"; then
    STATUS="up"
    MSG="\${SERVICE_NAME}_activated"
else
    STATUS="down"
    MSG="\${SERVICE_NAME}_not_activated"
fi

/usr/bin/curl -fsS "\${KUMA_URL}/api/push/\${TOKEN}?status=\${STATUS}&msg=\${MSG}" >/dev/null 2>&1
EOF

chmod +x /usr/local/bin/check_supervisord.sh

# 2) Install/replace cron entry for this script
( crontab -l 2>/dev/null | grep -v "check_supervisord.sh"; echo "* * * * * /usr/local/bin/check_supervisord.sh >> /var/log/check_supervisord.log 2>&1" ) | crontab -
```

Run this as `root` on each target server.  
It will:

- Create or update the script.
- Ensure it is executable.
- Install a cron job that runs it every minute.

---

## 9. Adapting for Other Services

You can reuse this pattern for other services:

- Change `SERVICE_NAME` to the systemd unit you care about, e.g.
  - `nginx`
  - `httpd`
  - `rabbitmq-server`
- Create separate Push monitors and tokens for each service or group of servers.
- Use different messages in `MSG` to identify the service and server.

Example:

```bash
SERVICE_NAME="nginx"
MSG="\${SERVICE_NAME}_tk-app3_active"
```

This makes alerts more descriptive in Uptime Kuma and in chat notifications.

---

## 10. Summary

- **Uptime Kuma Push monitor** gives you a simple HTTP endpoint.
- The **token** is the unique part of the Push URL and identifies the monitor.
- A small **shell script + cron** on each server:
  - Checks `systemctl is-active supervisord`.
  - Sends `status=up` or `status=down` to Kuma.
- Uptime Kuma:
  - Tracks the status.
  - Sends alerts to your chat workspace when the state changes.

This setup gives you lightweight, low-overhead monitoring of `supervisord` (or any other `systemd` service) across multiple servers with clear, centralized notifications.
